/** vite-plugin-necessary-import
 *
 * @author halo951(https://github.com/halo951)
 * @license MIT
 */
import{normalizePath as t,transformWithEsbuild as e,createFilter as o,createLogger as r}from"vite";import{globSync as n}from"glob";import*as s from"node:path";import a from"node:module";const i=(t,e)=>{const o=a.createRequire(import.meta.url);try{return o(e?o.resolve(t,{paths:[e]}):t)}catch(t){}},l=new Map,c=e=>{const{root:o,library:r,styleDir:a,extension:c}=e;return e=>{const p=e.replace(/[A-Z]/g,((t,e)=>(e?"-":"")+t.toLowerCase()));const m=e.toLowerCase(),u=((e,o,r,a)=>{const c=s.join(e,"node_modules",o,r),p=`${o}@${i(`${o}/package.json`,e)?.version||"*"}`;return l.get(p)??(()=>{const e=n(a,{matchBase:!0,cwd:c}).map((e=>t(e)));return l.set(p,e),e})()})(o,r,a,c).filter((t=>{const e=t.split("/").map((t=>s.basename(t,s.extname(t))));return e.some((t=>[p,m].includes(t.toLowerCase())))})).map((e=>t(s.join(r,a,e)))).sort(((t,e)=>{let o=[0,0];return o[0]+=t.replace(/[-]/,"").toLowerCase().indexOf(m),o[1]+=e.replace(/[-]/,"").toLowerCase().indexOf(m),o[0]+=c.length-c.findIndex((e=>e.includes(s.extname(t)))),o[1]+=c.length-c.findIndex((t=>t.includes(s.extname(e)))),-1*(o[0]-o[1])}));return u.length>0?u[0]:void 0}};var p={name:"default",match:t=>!0,tranfromToBlock:async(t,e)=>[{type:"script",source:e,map:null}],output:async(t,o)=>await e(o[0].source,t,{})},m={name:"vue",match:t=>!!t.replace(/\?.*/,"").match(/\.vue$/),tranfromToBlock:async(t,e,{root:o})=>[{type:"script",source:e,map:null}],output:async(t,e)=>({code:e.map((t=>t.source)).join("\n"),map:null})};class u{logger;ctx;root;options;baseStyle;parsers=[m,p];getParser(t,e){return this.parsers.find((o=>o.match(t,e)))}async transform(t,e){const{root:o,ctx:r}=this,n=this.getParser(t,e);if(!n)return;this.logger.info(`necessary import > parser: ${n.name}, file: ${t}`),"silent"===this.options.logLevel&&console.time(`parser: ${n.name}`);const s=await n.tranfromToBlock(t,e,{ctx:r,root:o});for(const t of s)if(["script","scriptsetup"].includes(t.type)){const e=this.appendStyleImport(t.source);e&&(t.source=e)}return"silent"===this.options.logLevel&&console.timeEnd(`parser: ${n.name}`),n.output(t,s)}appendStyleImport(t){const{library:e,noComponent:o}=this.options,r=this.ctx.parse(t),{body:n}=r,s=t=>t.source.value===e,a=[];for(const t of n)if("ImportDeclaration"===t.type&&s(t))for(const e of t.specifiers)if(e.imported?.name){const t=e.imported.name;a.push(t)}const i=a.filter((t=>!(o??[]).includes(t))).map((t=>this.transformComponentNameToStyleImportStatement(t))).filter((t=>!!t));if(i.length)return i.push(t),this.baseStyle&&i.unshift(this.baseStyle),i.join("\n")}transformComponentNameToStyleImportStatement(t){const{noFoundStyle:e}=this.options,o=this.createStylePathFactory()(t);if(o)return this.logger.info(`necessary import > import '${o}'`),`import '${o}';`;{if(null===o)return;const r=`necessary import > 组件: '${t}' 未找到样式文件, 如果这不是一个组件, 那么需要添加 'noComponent' 配置`;if("error"===e)throw new Error(r);"warn"===e&&this.logger.warn(r)}}createStylePathFactory(){const{root:t}=this,{library:e,extension:o,styleDir:r}=this.options;let n;return n="function"==typeof r?r:c({root:t,library:e,styleDir:r,extension:o}),n}appendBaseStyleImportStatement(t){if(t){if("string"==typeof t){const e=/import \['"]/.test(t);this.baseStyle=e?t:`import '${t}';`}else{const t=this.createStylePathFactory()("base");t&&(this.baseStyle=`import '${t}';`)}this.logger.info(`necessary import > ${this.options.library} base style: '${this.baseStyle}'`)}}}const y=t=>{const e=t.include??["src/**/*.ts(x|)","src/**/*.js(x|)","src/**/*.vue"],n=t.exclude??[],s=t.logLevel??"warn",a=o(e,n),l=r(s),c=new u;return{name:"vite-plugin:necessary-import",enforce:"post",configResolved(o){var r,a;r=t.library,a=o.root,i(`${r}/package.json`,a)||l.warn(`> necessaryImport: The library '${t.library}' is not install.`);const p=t.styleDir??"/";let m=["css","less","scss","sass"];t.extension instanceof Array&&(m=t.extension),m=m.map((t=>t.includes("*")?t:`*.${t}`)),c.root=o.root,c.logger=l,c.options={library:t.library,noFoundStyle:t.noFoundStyle??"warn",noComponent:t.noComponent??[],include:e,exclude:n,logLevel:s,styleDir:p,extension:m,base:null}},buildStart(){c.ctx=this,c.appendBaseStyleImportStatement(t.base)},async transform(t,e){if(!a(e))return;return await c.transform(e,t)}}};export{y as necessaryImport};
