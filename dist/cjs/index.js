/** vite-plugin-necessary-import
 *
 * @author halo951(https://github.com/halo951)
 * @license MIT
 */
"use strict";var e=require("vite"),t=require("glob"),r=require("node:path"),o=require("node:module");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var o=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,o.get?o:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var s=n(r);const a=(e,t)=>{const r=o.createRequire("undefined"==typeof document?require("url").pathToFileURL(__filename).href:document.currentScript&&document.currentScript.src||new URL("index.js",document.baseURI).href);try{return r(t?r.resolve(e,{paths:[t]}):e)}catch(e){}},i=new Map,c=r=>{const{root:o,library:n,styleDir:c,extension:l}=r;return r=>{const u=r.replace(/[A-Z]/g,((e,t)=>(t?"-":"")+e.toLowerCase()));const p=r.toLowerCase(),m=((r,o,n,c)=>{const l=s.join(r,"node_modules",o,n),u=`${o}@${a(`${o}/package.json`,r)?.version||"*"}`;return i.get(u)??(()=>{const r=t.globSync(c,{matchBase:!0,cwd:l}).map((t=>e.normalizePath(t)));return i.set(u,r),r})()})(o,n,c,l).filter((e=>{const t=e.split("/").map((e=>s.basename(e,s.extname(e))));return t.some((e=>[u,p].includes(e.toLowerCase())))})).map((t=>e.normalizePath(s.join(n,c,t)))).sort(((e,t)=>{let r=[0,0];return r[0]+=e.replace(/[-]/,"").toLowerCase().indexOf(p),r[1]+=t.replace(/[-]/,"").toLowerCase().indexOf(p),r[0]+=l.length-l.findIndex((t=>t.includes(s.extname(e)))),r[1]+=l.length-l.findIndex((e=>e.includes(s.extname(t)))),-1*(r[0]-r[1])}));return m.length>0?m[0]:void 0}};var l={name:"default",match:e=>!0,tranfromToBlock:async(e,t)=>[{type:"script",source:t,map:null}],output:async(t,r)=>await e.transformWithEsbuild(r[0].source,t,{})},u={name:"vue",match:e=>!!e.replace(/\?.*/,"").match(/\.vue$/),tranfromToBlock:async(e,t,{root:r})=>[{type:"script",source:t,map:null}],output:async(e,t)=>({code:t.map((e=>e.source)).join("\n"),map:null})};class p{logger;ctx;root;options;parsers=[u,l];getParser(e,t){return this.parsers.find((r=>r.match(e,t)))}async transform(e,t){const{root:r,ctx:o}=this,n=this.getParser(e,t);if(!n)return;this.logger.info(`necessary import > parser: ${n.name}, file: ${e}`),"silent"===this.options.logLevel&&console.time(`parser: ${n.name}`);const s=await n.tranfromToBlock(e,t,{ctx:o,root:r});for(const e of s)if(["script","scriptsetup"].includes(e.type)){const t=this.appendStyleImport(e.source);t&&(e.source=t)}return"silent"===this.options.logLevel&&console.timeEnd(`parser: ${n.name}`),n.output(e,s)}appendStyleImport(e){const{library:t,noComponent:r}=this.options,o=this.ctx.parse(e),{body:n}=o,s=e=>e.source.value===t,a=[];for(const e of n)if("ImportDeclaration"===e.type&&s(e))for(const t of e.specifiers)if(t.imported?.name){const e=t.imported.name;a.push(e)}const i=a.filter((e=>!(r??[]).includes(e))).map((e=>this.transformComponentNameToStyleImportStatement(e))).filter((e=>!!e));if(i.length)return[...i,e].join("\n")}transformComponentNameToStyleImportStatement(e){const{noFoundStyle:t}=this.options,r=this.createStylePathFactory()(e);if(r)return this.logger.info(`necessary import > import '${r}'`),`import '${r}';`;{if(null===r)return;const o=`necessary import > 组件: '${e}' 未找到样式文件, 如果这不是一个组件, 那么需要添加 'noComponent' 配置`;if("error"===t)throw new Error(o);"warn"===t&&this.logger.warn(o)}}createStylePathFactory(){const{root:e}=this,{library:t,extension:r,styleDir:o}=this.options;let n;return n="function"==typeof o?o:c({root:e,library:t,styleDir:o,extension:r}),n}}exports.necessaryImport=t=>{const r=t.include??["src/**/*.ts(x|)","src/**/*.js(x|)","src/**/*.vue"],o=t.exclude??[],n=t.logLevel??"warn",s=e.createFilter(r,o),i=e.createLogger(n),c=new p;return{name:"vite-plugin:necessary-import",enforce:"post",configResolved(e){if(s=t.library,l=e.root,!a(`${s}/package.json`,l))throw new Error(`> necessaryImport: The library '${t.library}' is not install.`);var s,l;const u=t.styleDir??"/";let p=["css","less","scss","sass"];t.extension instanceof Array&&(p=t.extension),p=p.map((e=>e.includes("*")?e:`*.${e}`)),c.root=e.root,c.logger=i,c.options={library:t.library,noFoundStyle:t.noFoundStyle??"warn",noComponent:t.noComponent??[],include:r,exclude:o,logLevel:n,styleDir:u,extension:p}},buildStart(){c.ctx=this},async transform(e,t){if(!s(t))return;return await c.transform(t,e)}}};
